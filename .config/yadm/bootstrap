#!/bin/bash
# TODO: use https://github.com/Homebrew/homebrew-bundle for macos
# TODO: SIMPLIFY, ask no questions

SYSTEM_TYPE=$(uname -s)

COMMON_PACKAGES=(
  "docker",
  "docker-compose",
  "fd",
  "git",
  "htop",
  "neovim",
  "tmux",
  "wget",
  "yarn",
  "go",
  "rbenv",
  "rbenv-aliases",
  "rbenv-default-gems",
  "rbenv-use",
  "ripgrep",
  "ruby-build",
  "python",
  "starship",
)

# INSTALL DEPENDENCIES
echo "installing dependencies"
if [ "$SYSTEM_TYPE" = "Darwin" ]; then
  if ! command -v brew >/dev/null 2>&1; then
    BREW_URL = 'https://raw.githubusercontent.com/Homebrew/install/master/install'
    echo ">>> Installing homebrew.."
    echo | /usr/bin/ruby -e "$(curl -fsSL $BREW_URL)" > /dev/null
  fi
  BREW_PACKAGES=()
  brew tap homebrew/cask-fonts  
  brew tap homebrew/cask-drivers
  brew install (${COMMON_PACKAGES[@]} ${BREW_PACKAGES[@]})
elif [ "$SYSTEM_TYPE" = "Linux" ]; then
  PACMAN_PACKAGES=("openssh", "pulseaudio-modules-bt-git", "python-pip", "tlp", "xclip")
  if command -v yay >/dev/null 2>&1; then
    sudo pacman -S yay --noconfirm --needed
  fi
  yay -S (${COMMON_PACKAGES[@]} ${PACMAN_PACKAGES[@]} ) --noconfirm --needed
fi

# ZSH
# Set zsh as default shell
chsh -s $(which zsh)
# Install zim framework
if [ `ls -A ~/.zim/ | wc -m` == "0" ]; then
  echo "bootstraping ZSH"
  chsh -s /usr/bin/zsh
  git clone --recursive https://github.com/zimfw/zimfw.git ~/.zim
fi

# Install tmux  plugins
if [ `ls -A ~/.tmux/plugins/tpm | wc -m` == "0" ]; then
  echo "bootstraping tmux"
  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && \
    ~/.tmux/plugins/tpm/scripts/install_plugins.sh
fi

# Install neovim plugins
if command -v nvim >/dev/null 2>&1; then
  echo "Bootstraping NeoVim"

  git clone https://github.com/wbthomason/packer.nvim \
    ~/.local/share/nvim/site/pack/packer/start/packer.nvim

  nvim --headless +PackerCompile +PackerSync +q
  ~/.bin/install_lsp.sh
fi

# JS dependencies
YARN_PACKAGES=("eslint_d", "stylelint", "prettier", "typescript", "create-react-app")
sudo yarn global add ${YARN_PACKAGES[@]}

# Basic desktop apps
read -r -p "Install Basic Desktop apps? [y/N] " response
response=${response,,}
if [[ "$response" =~ ^(yes|y)$ ]]; then
  COMMON_DESKTOP_PACKAGES=("alacritty", "firefox", "google-chrome",)

  BREW_DESKTOP_PACKAGES=(
    "appcleaner",
    "disk-inventory-x",
    "google-backup-and-sync",
    "itsycal",
    "keka",
    "maccy",
    "notion",
    "rectangle",
    "slack",
  )

  PACMAN_DESKTOP_PACKAGES=(
    "nerd-fonts-iosevka",
    "notion-app",
    "noto-fonts",
    "pavucontrol",
    "slack-desktop",
    "ttf-joypixels",
  )
  if [ "$SYSTEM_TYPE" = "Darwin" ]; then
    brew install (${COMMON_DESKTOP_PACKAGES[@]} ${BREW_DESKTOP_PACKAGES[@]})

  elif [ "$SYSTEM_TYPE" = "Linux" ]; then
    yay -S (${COMMON_DESKTOP_PACKAGES[@]} ${LINUX_DESKTOP_PACKAGES[@]}) --noconfirm --needed
  fi
fi

read -r -p "Install Extra packages? [y/N] " response
response=${response,,}
if [[ "$response" =~ ^(yes|y)$ ]]; then
  if [ "$SYSTEM_TYPE" = "Darwin" ]; then
    COMMON_EXTRA_PACKAGES=("bitwarden", "calibre", "spotify", "zoom")

    BREW_EXTRA_PACKAGES=(
      "android-platform-tools",
      "beardedspice",
      "dbeaver-community",
      "figma",
      "iina",
      "logitech-options",
      "postman",
      "todoist",
      "transmission",
    )

    PACMAN_EXTRA_PACKAGES=(
      "android-tools"
      "dbeaver"
      "libreoffice"
      "figma-linux"
      "pinta"
      "postman-bin"
      "transmission-gtk"
    )

    brew install (${COMMON_EXTRA_PACKAGES[@]} ${BREW_EXTRA_PACKAGES[@]})
  elif [ "$SYSTEM_TYPE" = "Linux" ]; then
    yay -S (${COMMON_EXTRA_PACKAGES[@]} ${LINUX_EXTRA_PACKAGES[@]}) --noconfirm --needed
  fi
fi

if [ "$SYSTEM_TYPE" = "Darwin" ]; then
  sh ./macos.sh
fi

if [ "$SYSTEM_TYPE" = "Linux" ]; then
  sh ./manjaro-linux.sh
fi
